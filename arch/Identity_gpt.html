<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>.NET 8 Identity Toy App in F#</title>
  <style>
    body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; background: #f4f4f4; color: #333; }
    h1, h2, h3 { color: #003366; }
    code { background: #eee; padding: 2px 5px; border-radius: 3px; }
    pre { background: #eee; padding: 10px; overflow: auto; border-radius: 3px; }
    .note { background: #fff3cd; padding: 10px; border-left: 5px solid #ffeeba; }
    .info { background: #cce5ff; padding: 10px; border-left: 5px solid #b8daff; }
    .promptLittle { font-size: 2px;}
  </style>
</head>
<body>

<div class='promptLittle'>
<details>
  <summary>Prompt</summary>
<pre>
Please output your answer(s) in HTML format (not markdown).
(1) I am building a dotNet FSharp application and wish to add Identity to handle the Security aspect.  I have a complicated setup which involves more than roles: My app has Table-level security as well as field-level.  Identity is more-or-less a black box for me; I do not know the internals.
(2) I am currently at the point where in order to continue working on the back-end I need to have a rough idea of what Identity needs (fields, defaults, etc.) from the backend-side to be able to do it's work.
(3) Therefore I now need to build a "toy" dotnet app which I can test and customize before finalizing my work on the back-end.
(4) I am using an article by Kostis Grontis "Exploring Identity ENdpoints in .net 8" from his website: https://kgrontis.github.io/posts/.
(5) I want you to take his code and rewrite it in FSharp.  Here are the other changes I want to make to that tiny app he made: (a) I want to use a custom DatabasContext (instead of SQLite, I want to use an in-memory Fsharp list.  I believe there is a template for an in-mem SQLSvr tbl)  I need to know what fields this table needs; and wish to customize it by adding some of my own (Salary, Manager, FirstNm, LastNm, DeptNm) (b) I don't wish to use Swagger to test the endpoints; isn't there a way I can use my browser's console to test it instead?  I don't mind writing some javascript to do so.  (c) I wish to test _all_ the endpoints (including resetting passwords etc.) so if there's a simple script you can give me to test POSTs, pls do so.
(6) When I have built/tested this toy application I will need to add custom middleware to test roles/endpoints; which I shall do after we have everthing working.  Just looking for the basics right now.
</pre></details></div>
<p>
  <h1>.NET 8 Identity Toy App (F# Minimal API)</h1>

  <h2>1. Project Setup</h2>
  <pre>
dotnet new webapi -lang F# -o IdentityToy -minimal -f net8.0
cd IdentityToy
dotnet add package Microsoft.AspNetCore.Identity.EntityFrameworkCore
dotnet add package Microsoft.EntityFrameworkCore.InMemory
dotnet add package Microsoft.AspNetCore.Authentication.JwtBearer
  </pre>
  <p>Here we replace SQLite from Kostis Grontis’s article with <code>InMemory</code>, and reference needed Identity & JWT auth.</p>

  <h2>2. Define User & Context</h2>
  <pre><code lang="fsharp">namespace IdentityToy

open Microsoft.AspNetCore.Identity
open Microsoft.EntityFrameworkCore
open Microsoft.AspNetCore.Identity.EntityFrameworkCore

type AppUser() =
    inherit IdentityUser()

type AppDbContext(options: DbContextOptions<AppDbContext>) =
    inherit IdentityDbContext<AppUser>(options)

    // Extra fields table-level, you can add Salary etc. later as DbSet&lt;_&gt; to model table.
  </code></pre>
  <p>Identity needs a store user table using <code>IdentityDbContext&lt;AppUser&gt;</code> :contentReference[oaicite:0]{index=0}. You can later create your model table (e.g., Employees) adding <code>Salary, Manager, FirstNm, LastNm, DeptNm</code> as a regular EF Core entity.</p>

  <h2>3. Register Services & Identity Endpoints</h2>
  <pre><code lang="fsharp">open Microsoft.AspNetCore.Builder
open Microsoft.Extensions.DependencyInjection

let builder = WebApplication.CreateBuilder()

builder.Services.AddDbContext<AppDbContext>(fun opts ->
    opts.UseInMemoryDatabase("ToyDb") |> ignore)

builder.Services.AddAuthorization()
builder.Services
    .AddIdentityApiEndpoints&lt;AppUser&gt;()
    .AddEntityFrameworkStores&lt;AppDbContext&gt;()

builder.Services.AddAuthentication().AddJwtBearer(fun options ->
    // configure JWT options here (optional, identity returns opaque token by default)
    ())

let app = builder.Build()

app.UseAuthentication()
app.UseAuthorization()

app.MapIdentityApi&lt;AppUser&gt;() |> ignore

app.MapGet("/weatherforecast", fun () ->
    [| {| date = System.DateTime.UtcNow; tempC = 25; summary = "Sunny" |} |])
    .RequireAuthorization()
  </code></pre>
  <p>This mirrors the setup in Kostis and Andrew Lock’s posts. The AddIdentityApiEndpoints configures endpoints like <code>/register</code>, <code>/login</code>, etc. :contentReference[oaicite:1]{index=1}</p>

  <h2>4. Adding Custom Fields Table</h2>
  <pre><code lang="fsharp">type Employee =
    { Id: int
      FirstNm: string
      LastNm: string
      DeptNm: string
      Salary: decimal
      Manager: string }

type AppDbContext(options) =
    inherit IdentityDbContext<AppUser>(options)
    [<DefaultValue>]
    val mutable employees: DbSet&lt;Employee&gt;
    member this.Employees with get() = this.employees and set v = this.employees <- v
  </code></pre>
  <p>You need to <code>builder.Services.AddDbContext</code> above — that adds your extra data. Table-level and field-level logic you'll build in middleware later.</p>

  <h2>5. Testing Endpoints with Browser Console</h2>
  <p>Yes—you can call the endpoints via JavaScript in the browser. Example:</p>
  <pre><code>async function register() {
  const res = await fetch("/register", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username:"u1", password:"P@ssw0rd!", email:"u1@example.com" })
  });
  console.log(await res.json());
}

async function login() {
  const res = await fetch("/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username:"u1", password:"P@ssw0rd!" })
  });
  const data = await res.json();
  console.log(data);
  localStorage.setItem("token", data.access_token);
}

async function getForecast() {
  const token = localStorage.getItem("token");
  const res = await fetch("/weatherforecast", {
    headers: { "Authorization": `Bearer ${token}` }
  });
  console.log(await res.json());
}</code></pre>
  <p>Open devtools console, paste these functions to test manually.</p>

  <h2>6. Full Test Script</h2>
  <pre><code>// run in browser console or in Postman-like .http file
await register();
await login();
await getForecast();</code></pre>

  <h2>7. What Identity Requires from Backend</h2>
  <ul>
    <li>Table <code>AspNetUsers</code> with username, email, password-hash, security-stamp, etc.</li>
    <li>Email, Username, PasswordHash, NormalizedUserName, NormalizedEmail, etc.—default fields provided by IdentityUser :contentReference[oaicite:2]{index=2}.</li>
    <li>Entity <code>Employee</code> with added fields: Salary, Manager, FirstNm, LastNm, DeptNm as needed by you.</li>
  </ul>

  <h2>8. Next Steps</h2>
  <p>Once endpoints are functioning, you can:</p>
  <ol>
    <li>Add F# middleware to enforce table-level security on <code>Employees</code>.</li>
    <li>Implement field-level filtering, customizing EF Core or filtering in memory.</li>
    <li>Eventually, swap InMemory with SQL Server or another store.</li>
  </ol>

  <h2>Summary</h2>
  <p>We’ve translated Kostis Grontis’s C# sample into F#, using an in-memory DB, added your custom entity fields, and created JS test stubs for all Identity endpoints without Swagger.</p>
  <p>Next we can jump into middleware and role testing once this runs OK. Let me know when you’re ready to move forward!</p>
</body>
</html>
```
